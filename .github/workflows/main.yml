name: Build, publish and deploy to MonsterASP.NET

on:
  push:
    branches: [ main ]

jobs:
  build_and_deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore "./FA25-CP.CryoFert/FA25-CP.CryoFert-BE/FA25-CP.CryoFert-BE.csproj"

      - name: Run tests
        run: echo "No test project found – skipping tests."

      - name: Build
        run: dotnet build "./FA25-CP.CryoFert/FA25-CP.CryoFert-BE/FA25-CP.CryoFert-BE.csproj" --configuration Release --no-restore

      - name: Publish
        run: dotnet publish "./FA25-CP.CryoFert/FA25-CP.CryoFert-BE/FA25-CP.CryoFert-BE.csproj" --configuration Release --output ./publish --runtime win-x86 --self-contained false

      - name: List publish output
        run: dir publish

      # Debug step: kiểm tra secrets có được set hay không (KHÔNG in password)
      - name: "Debug: check server secret present"
        shell: pwsh
        env:
          SC: "${{ secrets.SERVER_COMPUTER_NAME }}"
          WS: "${{ secrets.WEBSITE_NAME }}"
        run: |
          if ([string]::IsNullOrEmpty($env:SC)) {
            Write-Error "SERVER_COMPUTER_NAME is empty!"
            exit 1
          }
          Write-Host "SERVER_COMPUTER_NAME is set (length: $($env:SC.Length))"
          Write-Host "WEBSITE_NAME: $env:WS"

      - name: Deploy to MonsterASP.NET via WebDeploy
        uses: rasmusbuchholdt/simply-web-deploy@2.1.0
        with:
          website-name: ${{ secrets.WEBSITE_NAME }}
          server-computer-name: ${{ secrets.SERVER_COMPUTER_NAME }}
          server-username: ${{ secrets.SERVER_USERNAME }}
          server-password: ${{ secrets.SERVER_PASSWORD }}
          source-path: './publish'
          target-path: 'site\wwwroot'
