name: Build, publish and deploy to MonsterASP.NET   # Tên workflow

on:
  push:
    branches: [ main ]                              # Chỉ chạy khi push lên nhánh main

jobs:
  build_and_deploy:
    runs-on: windows-latest                         # Dùng runner Windows để publish Windows runtime

    steps:
      # B1: Checkout source
      - name: Checkout
        uses: actions/checkout@v4

      # B2: Setup .NET SDK 8
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # B3: Restore NuGet packages
      - name: Restore dependencies
        run: dotnet restore "./FA25-CP.CryoFert/FA25-CP.CryoFert-BE/FA25-CP.CryoFert-BE.csproj"

      # B4: (Skip tests) - sửa nếu có tests
      - name: Run tests
        run: echo "No test project found – skipping tests."

      # B5: Build project (Release)
      - name: Build
        run: dotnet build "./FA25-CP.CryoFert/FA25-CP.CryoFert-BE/FA25-CP.CryoFert-BE.csproj" --configuration Release --no-restore

      # B6: Publish to ./publish (Windows runtime)
      - name: Publish
        run: dotnet publish "./FA25-CP.CryoFert/FA25-CP.CryoFert-BE/FA25-CP.CryoFert-BE.csproj" --configuration Release --output ./publish --runtime win-x86 --self-contained false

      # B7: Show publish folder (quick check)
      - name: List publish output
        run: dir publish

      # B8: (Optional debug) verify SERVER_COMPUTER_NAME secret is not empty
      # Note: DON'T print secret value or password. This only checks presence.
      - name: Debug: check server secret present
        shell: pwsh
        env:
          SC: ${{ secrets.SERVER_COMPUTER_NAME }}
          WS: ${{ secrets.WEBSITE_NAME }}
        run: |
          if ([string]::IsNullOrEmpty($env:SC)) { Write-Error "SERVER_COMPUTER_NAME is empty!"; exit 1 }
          Write-Host "SERVER_COMPUTER_NAME is set (length: $($env:SC.Length))"
          Write-Host "WEBSITE_NAME: $env:WS"

      # B9: Deploy using simply-web-deploy
      # IMPORTANT: Here we expect SERVER_COMPUTER_NAME to be like "https://site36198.siteasp.net:8172"
      # and WEBSITE_NAME to be "site36198". If your host requires a full URL, change SERVER_COMPUTER_NAME secret
      # to include "/msdeploy.axd?site=site36198".
      - name: Deploy to MonsterASP.NET via WebDeploy
        uses: rasmusbuchholdt/simply-web-deploy@2.1.0
        with:
          website-name: ${{ secrets.WEBSITE_NAME }}                 # e.g. site36198
          server-computer-name: ${{ secrets.SERVER_COMPUTER_NAME }} # e.g. https://site36198.siteasp.net:8172
          server-username: ${{ secrets.SERVER_USERNAME }}           # e.g. site36198
          server-password: ${{ secrets.SERVER_PASSWORD }}           # WebDeploy password (secret)
          source-path: './publish'                                  # folder to copy
          target-path: 'site\wwwroot'                               # target dir on server
