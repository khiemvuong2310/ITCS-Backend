name: Build, publish and deploy to MonsterASP.NET   # Tên workflow

on:
  push:
    branches: [ main ]                              # Chỉ chạy khi push lên nhánh main

jobs:
  build_and_deploy:
    runs-on: windows-latest                         # Dùng runner Windows để publish Windows runtime

    steps:
      # B1: Lấy code từ repository
      - name: Checkout
        uses: actions/checkout@v4

      # B2: Cài .NET SDK (8.x)
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # B3: Restore NuGet packages cho project chính
      - name: Restore dependencies
        run: dotnet restore "./FA25-CP.CryoFert/FA25-CP.CryoFert-BE/FA25-CP.CryoFert-BE.csproj"

      # B4: (Tạm skip tests) - sửa lại nếu bạn có test project
      - name: Run tests
        run: echo "No test project found – skipping tests."   # Thay bằng dotnet test <path> nếu có tests

      # B5: Build project (Release)
      - name: Build
        run: dotnet build "./FA25-CP.CryoFert/FA25-CP.CryoFert-BE/FA25-CP.CryoFert-BE.csproj" --configuration Release --no-restore

      # B6: Publish ra folder ./publish
      # --runtime win-x86: build theo runtime Windows (IIS). Thay đổi nếu server cần win-x64.
      - name: Publish
        run: dotnet publish "./FA25-CP.CryoFert/FA25-CP.CryoFert-BE/FA25-CP.CryoFert-BE.csproj" --configuration Release --output ./publish --runtime win-x86 --self-contained false

      # B7: (Tuỳ chọn) Liệt kê file publish để debug nhanh
      - name: Show publish folder
        run: dir publish

      # B8: Deploy bằng simply-web-deploy (KHÔNG DÙNG `package`)
      # IMPORTANT:
      # - simply-web-deploy expects a folder (source-path) to copy to target (target-path)
      # - server-computer-name should be set in Secrets; recommended full WebDeploy URL:
      #   https://<server>:8172/msdeploy.axd?site=<site_name>
      - name: Deploy to MonsterASP.NET via WebDeploy
        uses: rasmusbuchholdt/simply-web-deploy@2.1.0
        with:
          website-name: ${{ secrets.WEBSITE_NAME }}                 # e.g. site36198
          server-computer-name: ${{ secrets.SERVER_COMPUTER_NAME }} # e.g. https://site36198.siteasp.net:8172/msdeploy.axd?site=site36198
          server-username: ${{ secrets.SERVER_USERNAME }}           # e.g. site36198
          server-password: ${{ secrets.SERVER_PASSWORD }}           # WebDeploy password
          source-path: './publish'                                  # Thư mục đã publish
          target-path: 'site\wwwroot'                               # Đích trên server IIS (thường site\wwwroot)
